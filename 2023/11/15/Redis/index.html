<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"hunter1023.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"flat"},"fold":{"enable":true,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"utterances","storage":true,"lazyload":false,"nav":null,"activeClass":"utterances"},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":3,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="什么是RedisRedis是基于C语言开发的NoSQL数据库，它是一种存储KV键值对数据的内存数据库，因此读写速度非常快，被广泛应用于分布式缓存方向。 Redis内置了多种数据类型实现：  5种基础数据类型 String List Set Hash Zset （有序集合）   3种特殊数据类型 HyperLogLog（基数统计） Bitmap（位图） Geospatial (地理位置)    Re">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis">
<meta property="og:url" content="https://hunter1023.github.io/2023/11/15/Redis/index.html">
<meta property="og:site_name" content="Talk is cheap">
<meta property="og:description" content="什么是RedisRedis是基于C语言开发的NoSQL数据库，它是一种存储KV键值对数据的内存数据库，因此读写速度非常快，被广泛应用于分布式缓存方向。 Redis内置了多种数据类型实现：  5种基础数据类型 String List Set Hash Zset （有序集合）   3种特殊数据类型 HyperLogLog（基数统计） Bitmap（位图） Geospatial (地理位置)    Re">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2024/05/08/CYrpu6e25VFJsaA.png">
<meta property="og:image" content="https://s2.loli.net/2024/05/08/CgdAGeRpVjiEoPZ.png">
<meta property="og:image" content="https://s2.loli.net/2024/05/08/mdcQSf2gROHxC1z.png">
<meta property="og:image" content="https://s2.loli.net/2024/05/08/QeTj7GOyLu5DUvf.png">
<meta property="og:image" content="https://s2.loli.net/2024/05/09/dpgyu3QUiDNKWlf.png">
<meta property="og:image" content="https://s2.loli.net/2024/05/11/2nDibMxHfehsySu.png">
<meta property="og:image" content="https://s2.loli.net/2024/05/11/ICKuGpRJNzmqWOo.png">
<meta property="og:image" content="https://s2.loli.net/2024/05/13/SQg78t69MfY5u2J.png">
<meta property="og:image" content="https://s2.loli.net/2023/11/15/2iSVrqBb7d1yMjk.png">
<meta property="og:image" content="https://oss.itbaima.cn/internal/markdown/2023/03/06/VK3k7EAZDT1fjIo.jpg">
<meta property="og:image" content="https://oss.itbaima.cn/internal/markdown/2023/03/06/JYiOHBdtT7jC98R.png">
<meta property="og:image" content="https://s2.loli.net/2025/01/15/xQKzrPm1uSw2Zy6.png">
<meta property="og:image" content="https://s2.loli.net/2025/01/15/RGZVbsl1uHjhg3P.png">
<meta property="og:image" content="https://s2.loli.net/2025/01/15/kKtSEcwyCz4HTIZ.png">
<meta property="og:image" content="https://s2.loli.net/2025/01/15/XVykFqoNpBP24zt.png">
<meta property="og:image" content="https://oss.itbaima.cn/internal/markdown/2023/03/06/JKDHFTiCr2t5Oj9.png">
<meta property="article:published_time" content="2023-11-15T02:32:56.000Z">
<meta property="article:modified_time" content="2025-02-10T14:38:41.000Z">
<meta property="article:author" content="Hunter">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2024/05/08/CYrpu6e25VFJsaA.png">


<link rel="canonical" href="https://hunter1023.github.io/2023/11/15/Redis/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://hunter1023.github.io/2023/11/15/Redis/","path":"2023/11/15/Redis/","title":"Redis"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Redis | Talk is cheap</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Talk is cheap</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="搜索..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFRedis"><span class="nav-number">1.</span> <span class="nav-text">什么是Redis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="nav-number">2.</span> <span class="nav-text">基本操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E5%AF%B9%E8%B1%A1"><span class="nav-number">3.</span> <span class="nav-text">数据结构与对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2-SDS-Simple-Dynamic-String"><span class="nav-number">3.1.</span> <span class="nav-text">简单动态字符串 (SDS, Simple Dynamic String)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E6%95%B0%E5%A4%8D%E6%9D%82%E5%BA%A6%E8%8E%B7%E5%8F%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E9%95%BF%E5%BA%A6"><span class="nav-number">3.1.1.</span> <span class="nav-text">常数复杂度获取字符串长度</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9D%9C%E7%BB%9D%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA"><span class="nav-number">3.1.2.</span> <span class="nav-text">杜绝缓冲区溢出</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%87%8F%E5%B0%91%E4%BF%AE%E6%94%B9%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%97%B6%E5%B8%A6%E6%9D%A5%E7%9A%84%E5%86%85%E5%AD%98%E9%87%8D%E5%88%86%E9%85%8D%E6%AC%A1%E6%95%B0"><span class="nav-number">3.1.3.</span> <span class="nav-text">减少修改字符串时带来的内存重分配次数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8"><span class="nav-number">3.1.4.</span> <span class="nav-text">二进制安全</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%93%BE%E8%A1%A8"><span class="nav-number">3.2.</span> <span class="nav-text">链表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E5%85%B8"><span class="nav-number">3.3.</span> <span class="nav-text">字典</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%93%88%E5%B8%8C%E8%A1%A8"><span class="nav-number">3.3.1.</span> <span class="nav-text">哈希表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%93%88%E5%B8%8C%E8%A1%A8%E8%8A%82%E7%82%B9"><span class="nav-number">3.3.2.</span> <span class="nav-text">哈希表节点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E5%85%B8%E7%9A%84%E7%BB%93%E6%9E%84"><span class="nav-number">3.3.3.</span> <span class="nav-text">字典的结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E9%94%AE%E5%86%B2%E7%AA%81"><span class="nav-number">3.3.4.</span> <span class="nav-text">解决键冲突</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#rehash"><span class="nav-number">3.3.5.</span> <span class="nav-text">rehash</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%B3%E8%B7%83%E8%A1%A8-skiplist"><span class="nav-number">3.4.</span> <span class="nav-text">跳跃表 skiplist</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B7%B3%E8%B7%83%E8%A1%A8%E8%8A%82%E7%82%B9"><span class="nav-number">3.4.1.</span> <span class="nav-text">跳跃表节点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B4%E6%95%B0%E9%9B%86%E5%90%88-intset"><span class="nav-number">3.5.</span> <span class="nav-text">整数集合 intset</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8D%87%E7%BA%A7"><span class="nav-number">3.5.1.</span> <span class="nav-text">升级</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8-ziplist"><span class="nav-number">3.6.</span> <span class="nav-text">压缩列表 ziplist</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%8B%E7%BC%A9%E5%88%97%E8%A1%A8%E8%8A%82%E7%82%B9%E7%9A%84%E6%9E%84%E6%88%90"><span class="nav-number">3.6.1.</span> <span class="nav-text">压缩列表节点的构成</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%BF%9E%E9%94%81%E6%9B%B4%E6%96%B0"><span class="nav-number">3.6.2.</span> <span class="nav-text">连锁更新</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1"><span class="nav-number">3.7.</span> <span class="nav-text">对象</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%B1%BB%E5%9E%8B%E4%B8%8E%E7%BC%96%E7%A0%81"><span class="nav-number">3.7.1.</span> <span class="nav-text">对象的类型与编码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AF%B9%E8%B1%A1"><span class="nav-number">3.7.2.</span> <span class="nav-text">字符串对象</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4"><span class="nav-number">3.7.2.1.</span> <span class="nav-text">字符串相关命令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%97%E8%A1%A8%E5%AF%B9%E8%B1%A1"><span class="nav-number">3.7.3.</span> <span class="nav-text">列表对象</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%88%97%E8%A1%A8%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4"><span class="nav-number">3.7.3.1.</span> <span class="nav-text">列表相关命令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%93%88%E5%B8%8C%E5%AF%B9%E8%B1%A1"><span class="nav-number">3.7.4.</span> <span class="nav-text">哈希对象</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%93%88%E5%B8%8C%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4"><span class="nav-number">3.7.4.1.</span> <span class="nav-text">哈希相关命令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%9B%86%E5%90%88%E5%AF%B9%E8%B1%A1"><span class="nav-number">3.7.5.</span> <span class="nav-text">集合对象</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%9B%86%E5%90%88%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4"><span class="nav-number">3.7.5.1.</span> <span class="nav-text">集合相关命令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88%E5%AF%B9%E8%B1%A1"><span class="nav-number">3.7.6.</span> <span class="nav-text">有序集合对象</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88%E7%9B%B8%E5%85%B3%E5%91%BD%E4%BB%A4"><span class="nav-number">3.7.6.1.</span> <span class="nav-text">有序集合相关命令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E5%85%B1%E4%BA%AB"><span class="nav-number">3.7.7.</span> <span class="nav-text">对象共享</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E7%9A%84%E7%A9%BA%E8%BD%AC%E6%97%B6%E9%95%BF"><span class="nav-number">3.7.8.</span> <span class="nav-text">对象的空转时长</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%8D%E5%9B%BE%E5%AF%B9%E8%B1%A1"><span class="nav-number">3.7.9.</span> <span class="nav-text">位图对象</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E4%B8%BA%E4%BB%80%E4%B9%88%E9%80%9F%E5%BA%A6%E5%BF%AB%EF%BC%9F"><span class="nav-number">4.</span> <span class="nav-text">Redis为什么速度快？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6"><span class="nav-number">5.</span> <span class="nav-text">Redis持久化机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RDB-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">5.1.</span> <span class="nav-text">RDB 持久化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AOF%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">5.2.</span> <span class="nav-text">AOF持久化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B"><span class="nav-number">6.</span> <span class="nav-text">Redis线程模型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E7%BC%93%E5%AD%98%E6%9B%B4%E6%96%B0%E7%AD%96%E7%95%A5"><span class="nav-number">7.</span> <span class="nav-text">常见的缓存更新策略</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Cache-Aside-Pattern-%E6%97%81%E8%B7%AF%E7%BC%93%E5%AD%98%E6%A8%A1%E5%BC%8F"><span class="nav-number">7.1.</span> <span class="nav-text">Cache Aside Pattern 旁路缓存模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Read-Write-Through-Pattern-%E8%AF%BB%E5%86%99%E7%A9%BF%E9%80%8F%E6%A8%A1%E5%BC%8F"><span class="nav-number">7.2.</span> <span class="nav-text">Read&#x2F;Write Through Pattern 读写穿透模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Write-Behind-Pattern-%E5%BC%82%E6%AD%A5%E7%BC%93%E5%AD%98%E5%86%99%E5%85%A5%E6%A8%A1%E5%BC%8F"><span class="nav-number">7.3.</span> <span class="nav-text">Write Behind Pattern 异步缓存写入模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E5%92%8C%E9%94%81%E6%9C%BA%E5%88%B6"><span class="nav-number">8.</span> <span class="nav-text">事务和锁机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Java%E4%B8%8ERedis%E4%BA%A4%E4%BA%92"><span class="nav-number">9.</span> <span class="nav-text">使用Java与Redis交互</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C-1"><span class="nav-number">9.1.</span> <span class="nav-text">基本操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SpringBoot%E6%95%B4%E5%90%88Redis"><span class="nav-number">9.2.</span> <span class="nav-text">SpringBoot整合Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96"><span class="nav-number">9.2.1.</span> <span class="nav-text">序列化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%93%8D%E4%BD%9Credis%E7%9A%84%E6%A8%A1%E6%9D%BF%E7%B1%BB-RedisTemplate"><span class="nav-number">9.2.1.1.</span> <span class="nav-text">操作redis的模板类 RedisTemplate</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#RedisSerializer-%E5%BA%8F%E5%88%97%E5%8C%96%E6%8E%A5%E5%8F%A3"><span class="nav-number">9.2.1.2.</span> <span class="nav-text">RedisSerializer 序列化接口</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89Redis%E5%BA%8F%E5%88%97%E5%8C%96%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">9.2.1.3.</span> <span class="nav-text">自定义Redis序列化的实现</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1"><span class="nav-number">9.2.2.</span> <span class="nav-text">事务</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8Redis%E5%81%9A%E7%BC%93%E5%AD%98"><span class="nav-number">10.</span> <span class="nav-text">使用Redis做缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MyBatis%E7%9A%84%E4%BA%8C%E7%BA%A7%E5%AD%98%E5%82%A8"><span class="nav-number">10.1.</span> <span class="nav-text">MyBatis的二级存储</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E7%BC%93%E5%AD%98%E7%B1%BB"><span class="nav-number">10.1.1.</span> <span class="nav-text">编写缓存类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="nav-number">10.1.2.</span> <span class="nav-text">编写配置类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8Mapper%E4%B8%8A%E5%90%AF%E7%94%A8%E6%AD%A4%E7%BC%93%E5%AD%98"><span class="nav-number">10.1.3.</span> <span class="nav-text">在Mapper上启用此缓存</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Token%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8"><span class="nav-number">10.2.</span> <span class="nav-text">Token持久化存储</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0PersistentTokenRepository%E6%8E%A5%E5%8F%A3"><span class="nav-number">10.2.1.</span> <span class="nav-text">实现PersistentTokenRepository接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9C%A8Mapper%E4%B8%8A%E5%90%AF%E7%94%A8MyBatis%E7%9A%84Redis%E4%BA%8C%E7%BA%A7%E7%BC%93%E5%AD%98"><span class="nav-number">10.2.2.</span> <span class="nav-text">在Mapper上启用MyBatis的Redis二级缓存</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E9%AA%8C%E8%AF%81Service"><span class="nav-number">10.2.3.</span> <span class="nav-text">实现验证Service</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SecurityConfiguration%E9%85%8D%E7%BD%AE"><span class="nav-number">10.2.4.</span> <span class="nav-text">SecurityConfiguration配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E5%A4%A7%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98"><span class="nav-number">11.</span> <span class="nav-text">三大缓存问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F"><span class="nav-number">11.1.</span> <span class="nav-text">缓存穿透</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="nav-number">11.2.</span> <span class="nav-text">缓存击穿</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="nav-number">11.3.</span> <span class="nav-text">缓存雪崩</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Hunter</p>
  <div class="site-description" itemprop="description">Tough times never last, but tough people do.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">98</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">37</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">175</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://hunter1023.github.io/2023/11/15/Redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Hunter">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Talk is cheap">
      <meta itemprop="description" content="Tough times never last, but tough people do.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Redis | Talk is cheap">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Redis<a href="https://github.com/Hunter1023/hexo_blog/edit/gh-pages/source/_posts/Redis.md" class="post-edit-link" title="编辑" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a>
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-11-15 10:32:56" itemprop="dateCreated datePublished" datetime="2023-11-15T10:32:56+08:00">2023-11-15</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-02-10 22:38:41" itemprop="dateModified" datetime="2025-02-10T22:38:41+08:00">2025-02-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="什么是Redis"><a href="#什么是Redis" class="headerlink" title="什么是Redis"></a>什么是Redis</h2><p>Redis是基于C语言开发的NoSQL数据库，它是一种<strong>存储KV键值对数据</strong>的内存数据库，因此读写速度非常快，被广泛应用于<strong>分布式缓存</strong>方向。</p>
<p>Redis内置了多种数据类型实现：</p>
<ul>
<li>5种基础数据类型<ol>
<li>String</li>
<li>List</li>
<li>Set</li>
<li>Hash</li>
<li>Zset （有序集合）</li>
</ol>
</li>
<li>3种特殊数据类型<ol>
<li>HyperLogLog（基数统计）</li>
<li>Bitmap（位图）</li>
<li>Geospatial (地理位置)</li>
</ol>
</li>
</ul>
<p>Reids还支持事务、<strong>持久化（将内存数据保存在磁盘中，重启时可以再次加载使用）</strong>、Lua脚本、多种开箱即用的集群方案（Redis Sentinel、Redis Cluster）。</p>
<span id="more"></span>

<hr>
<h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><p>Redis是一个键值数据库，因此，可以像Map一样的操作方式，通过键值对向Redis数据库中添加数据（操作起来类似于向一个HashMap中存放数据）。</p>
<p>在Redis下，<strong>数据库是由一个整数索引标识</strong>，而不是由一个数据库名称。 默认情况下，我们连接Redis数据库之后，会使用0号数据库，我们可以通过Redis配置文件中的参数来修改数据库总数，默认为16个。可以通过<code>select</code>语句进行切换：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> 序号<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol>
<li>向redis数据库中<strong>添加数据</strong></li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">set</span> <span class="token operator">&lt;</span><span class="token keyword">key</span><span class="token operator">></span> <span class="token operator">&lt;</span><span class="token keyword">value</span><span class="token operator">></span>

<span class="token comment">-- 批量添加</span>
mset <span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token keyword">key</span><span class="token operator">></span> <span class="token operator">&lt;</span><span class="token keyword">value</span><span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>所有存入的数据，<strong>默认以字符串的形式保存</strong>。键值具有一定的命名规范，以方便快速定位数据属于哪一个部分，比如用户数据：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 使用冒号进行板块分割，如下表示 设置某用户ID的name属性的值</span>
<span class="token keyword">set</span> <span class="token keyword">user</span>:info:某用户ID:name hunter<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ol start="2">
<li>通过键值<strong>获取存入的值</strong></li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">get <span class="token operator">&lt;</span><span class="token keyword">key</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ol start="3">
<li>redis在存值时，支持设置<strong>数据的过期时间</strong>：</li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">set</span> <span class="token operator">&lt;</span><span class="token keyword">key</span><span class="token operator">></span> <span class="token operator">&lt;</span><span class="token keyword">value</span><span class="token operator">></span> EX 秒
<span class="token keyword">set</span> <span class="token operator">&lt;</span><span class="token keyword">key</span><span class="token operator">></span> <span class="token operator">&lt;</span><span class="token keyword">value</span><span class="token operator">></span> PX 毫秒<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>也可以单独为其他的键值对设置过期时间：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">expire <span class="token operator">&lt;</span><span class="token keyword">key</span><span class="token operator">></span> 秒<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>通过如下命令查询还有多少时间过期：</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 秒级 显示</span>
ttl <span class="token operator">&lt;</span><span class="token keyword">key</span><span class="token operator">></span>

<span class="token comment">-- 毫秒级 显示</span>
pttl <span class="token operator">&lt;</span><span class="token keyword">key</span><span class="token operator">></span>

<span class="token comment">-- 设置为不过期</span>
persist <span class="token operator">&lt;</span><span class="token keyword">key</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<ol start="4">
<li><strong>删除数据</strong></li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 可批量删除</span>
del <span class="token punctuation">[</span><span class="token operator">&lt;</span><span class="token keyword">key</span><span class="token operator">></span><span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<hr>
<ol start="5">
<li><strong>查看键值</strong></li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 查看所有键值</span>
<span class="token keyword">keys</span> <span class="token operator">*</span>

<span class="token comment">-- 查询键是否存在</span>
<span class="token keyword">exists</span> <span class="token operator">&lt;</span><span class="token keyword">key</span><span class="token operator">></span>

<span class="token comment">-- 随机拿一个键</span>
randomkey<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<ol start="6">
<li><strong>移动数据</strong></li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">move <span class="token operator">&lt;</span><span class="token keyword">key</span><span class="token operator">></span> 数据库号<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<hr>
<ol start="7">
<li><strong>修改键名</strong></li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">rename</span> <span class="token operator">&lt;</span><span class="token keyword">key</span><span class="token operator">></span> <span class="token operator">&lt;</span>new <span class="token keyword">key</span> name<span class="token operator">></span>

<span class="token comment">-- 会检查新的名称是否已经存在</span>
renamex <span class="token operator">&lt;</span><span class="token keyword">key</span><span class="token operator">></span> <span class="token operator">&lt;</span>new <span class="token keyword">key</span> name<span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<ol start="8">
<li><strong>如果存放的是数字，可以进行自增自减操作</strong></li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">-- 等价于a = a + 1</span>
incr <span class="token operator">&lt;</span><span class="token keyword">key</span><span class="token operator">></span>

<span class="token comment">-- 等价于a = a + b</span>
incrby <span class="token operator">&lt;</span><span class="token keyword">key</span><span class="token operator">></span> b

<span class="token comment">-- 等价于a = a - 1</span>
decr <span class="token operator">&lt;</span><span class="token keyword">key</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<ol start="9">
<li><strong>查看值的数据类型</strong></li>
</ol>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">type</span> <span class="token operator">&lt;</span><span class="token keyword">key</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>



<hr>
<h2 id="数据结构与对象"><a href="#数据结构与对象" class="headerlink" title="数据结构与对象"></a>数据结构与对象</h2><h3 id="简单动态字符串-SDS-Simple-Dynamic-String"><a href="#简单动态字符串-SDS-Simple-Dynamic-String" class="headerlink" title="简单动态字符串 (SDS, Simple Dynamic String)"></a>简单动态字符串 (SDS, Simple Dynamic String)</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">struct</span> <span class="token class-name">sdshdr</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 记录buf数组中已使用字节的数量</span>
    <span class="token comment">// 等于SDS所保存字符串的长度</span>
    <span class="token keyword">int</span> len<span class="token punctuation">;</span>
    <span class="token comment">// 记录buf数组中未使用字节的数量</span>
    <span class="token keyword">int</span> free<span class="token punctuation">;</span>
    <span class="token comment">// 字节数组，用于保存字符串</span>
    <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>SDS遵循C字符串以空字符结尾的惯例，保存空字符的1字节空间不计算在SDS的len属性里面，并且为空字符分配额外的1字节空间，以及添加空字符到字符串末尾等操作，都是由SDS函数自动完成的，所以这个空字符对于SDS的使用者来说是完全透明的。遵循空字符结尾这一惯例的好处是，SDS可以直接重用一部分C字符串函数库里面的函数。</p>
<h4 id="常数复杂度获取字符串长度"><a href="#常数复杂度获取字符串长度" class="headerlink" title="常数复杂度获取字符串长度"></a>常数复杂度获取字符串长度</h4><p>通过使用SDS而不是C字符串，Redis将获取字符串长度所需的复杂度从$O(N)$降低到了$O(1)$，这确保了<strong>获取字符串长度的工作不会成为Redis的性能瓶颈</strong>。</p>
<hr>
<h4 id="杜绝缓冲区溢出"><a href="#杜绝缓冲区溢出" class="headerlink" title="杜绝缓冲区溢出"></a>杜绝缓冲区溢出</h4><p>SDS的空间分配策略<strong>杜绝了发生缓冲区溢出的可能性</strong>。当SDS API需要对SDS进行修改时，<strong>API会先检查SDS的空间是否满足修改所需的要求，如果不满足的话，API会自动将SDS的空间扩展至执行修改所需的大小，然后才执行实际的修改操作</strong>。</p>
<hr>
<h4 id="减少修改字符串时带来的内存重分配次数"><a href="#减少修改字符串时带来的内存重分配次数" class="headerlink" title="减少修改字符串时带来的内存重分配次数"></a>减少修改字符串时带来的<strong>内存重分配次数</strong></h4><ol>
<li><p><strong>空间预分配</strong></p>
<ol>
<li>如果对SDS进行修改之后，SDS的长度（也即是len属性的值）<strong>小于1MB</strong>，那么程序<strong>分配和len属性同样大小的未使用空间</strong>，这时SDS len属性的值将和free属性的值相同。</li>
<li>如果对SDS进行修改之后，SDS的长度将<strong>大于等于1MB</strong>，那么程序会<strong>分配1MB的未使用空间</strong>。</li>
</ol>
</li>
<li><p><strong>惰性空间释放</strong></p>
<p>  当SDS的API需要缩短SDS保存的字符串时，程序<strong>不立即回收缩短后多出来的字节，而是使用free属性将这些字节的数量记录起来，并等待将来使用</strong>。与此同时，SDS也提供了相应的API真正地释放SDS的未使用空间，所以不用担心惰性空间释放策略会造成内存浪费。</p>
</li>
</ol>
<hr>
<h4 id="二进制安全"><a href="#二进制安全" class="headerlink" title="二进制安全"></a>二进制安全</h4><p>虽然数据库一般用于保存文本数据，但使用数据库来保存二进制数据的场景也不少见，因此，为了确保Redis可以适用于各种不同的使用场景，<strong>所有SDS API都会以处理二进制的方式来处理SDS存放在buf数组里的数据，程序不会对其中的数据做任何限制、过滤、或者假设，数据在写入时是什么样的，它被读取时就是什么样</strong>。这也是我们<strong>将SDS的buf属性称为字节数组</strong>的原因——Redis不是用这个数组来保存字符，而是用它来保存一系列二进制数据。</p>
<p>使用SDS来保存之前提到的特殊数据格式就没有任何问题，因为<strong>SDS使用len属性的值而不是空字符来判断字符串是否结束</strong>。但SDS一样遵循C字符串以空字符结尾的惯例，这是<strong>为了让那些保存文本数据的SDS可以重用一部分&lt;string.h&gt;库定义的函数</strong>。</p>
<hr>
<h3 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h3><p>链表在Redis中的应用非常广泛，比如<strong>列表键的底层实现之一</strong>就是链表。当一个列表键包含了<strong>数量比较多的元素</strong>，又或者列表中<strong>包含的元素都是比较长的字符串</strong>时，Redis就会使用链表作为列表键的底层实现。</p>
<p>除了列表键之外，<strong>发布与订阅、慢查询、监视器</strong>等功能也用到了链表，Redis服务器本身还使用链表来<strong>保存多个客户端的状态信息</strong>，以及使用链表来<strong>构建客户端输出缓冲区（output buffer）</strong>。</p>
<p>每个链表节点使用<code>adlist.h/listNode</code>结构来表示：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">listNode</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 前置节点</span>
    <span class="token keyword">struct</span> <span class="token class-name">listNode</span> <span class="token operator">*</span> prev<span class="token punctuation">;</span>
    <span class="token comment">// 后置节点</span>
    <span class="token keyword">struct</span> <span class="token class-name">listNode</span> <span class="token operator">*</span> next<span class="token punctuation">;</span>
    <span class="token comment">// 节点的值</span>
    <span class="token keyword">void</span> <span class="token operator">*</span> value<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>listNode<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>虽然仅仅使用多个listNode结构就可以组成链表，但使用<code>adlist.h/list</code>来持有链表的话，操作起来会更方便：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">list</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 表头节点</span>
    listNode <span class="token operator">*</span> head<span class="token punctuation">;</span>
    <span class="token comment">// 表尾节点</span>
    listNode <span class="token operator">*</span> tail<span class="token punctuation">;</span>
    <span class="token comment">// 链表所包含的节点数量</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> len<span class="token punctuation">;</span>
    <span class="token comment">// 节点值复制函数</span>
    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>dup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 节点值释放函数</span>
    <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>free<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 节点值对比函数</span>
    <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>match<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> list<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>list结构为链表提供了表头指针<code>head</code>、表尾指针<code>tail</code>，以及链表长度计数器<code>len</code>，而dup、free和match成员则是用于实现多态链表所需的类型特定函数：</p>
<ul>
<li>dup函数用于复制链表节点所保存的值；</li>
<li>free函数用于释放链表节点所保存的值；</li>
<li>match函数则用于对比链表节点所保存的值和另一个输入值是否相等。</li>
</ul>
<p><img src="https://s2.loli.net/2024/05/08/CYrpu6e25VFJsaA.png" alt="由list结构和listNode结构组成的链表"></p>
<p>Redis的链表实现的特性可以总结如下：</p>
<ol>
<li><strong>双端</strong>：链表节点带有prev和next指针，获取某个节点的前置节点和后置节点的复杂度都是O（1）。</li>
<li><strong>无环</strong>：表头节点的prev指针和表尾节点的next指针都指向NULL，对链表的访问以NULL为终点。</li>
<li><strong>带表头指针和表尾指针</strong>：通过list结构的head指针和tail指针，程序获取链表的表头节点和表尾节点的复杂度为O（1）。</li>
<li><strong>带链表长度计数器</strong>：程序使用list结构的len属性来对list持有的链表节点进行计数，程序获取链表中节点数量的复杂度为O（1）。</li>
<li><strong>多态</strong>：链表节点使用<code>void*</code>指针来保存节点值，并且可以通过list结构的dup、free、match三个属性为节点值设置类型特定函数，所以链表可以用于保存各种不同类型的值。</li>
</ol>
<hr>
<h3 id="字典"><a href="#字典" class="headerlink" title="字典"></a>字典</h3><p>字典是用于<strong>保存键值对</strong>的抽象数据结构。字典在Redis中的应用相当广泛，比如<strong>对数据库的增、删、查、改操作构建在对字典的操作之上</strong>。</p>
<p>除了用来表示数据库之外，字典还是<strong>哈希键的底层实现之一</strong>，当一个哈希键包含的键值对比较多，又或者键值对中的元素都 是比较长的字符串时，Redis就会使用字典作为哈希键的底层实现。</p>
<p>Redis的字典使用<strong>哈希表作为底层实现</strong>，<strong>每个哈希表节点保存了字典中的一个键值对</strong>。</p>
<hr>
<h4 id="哈希表"><a href="#哈希表" class="headerlink" title="哈希表"></a>哈希表</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dictht</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 哈希表数组</span>
    dictEntry <span class="token operator">*</span><span class="token operator">*</span>table<span class="token punctuation">;</span>
    <span class="token comment">// 哈希表大小</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">;</span>
    <span class="token comment">// 哈希表大小掩码，用于计算索引值</span>
    <span class="token comment">// 总是等于size-1</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> sizemask<span class="token punctuation">;</span>
    <span class="token comment">// 该哈希表已有节点的数量</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> used<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> dictht<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>table属性是一个<strong>数组</strong>，数组中的<strong>每个元素都是一个指向<code>dict.h/dictEntry</code>结构的指针，每个dictEntry结构保存着一个键值对</strong>。</li>
<li><strong>sizemask和哈希值一起决定一个键应该被放到table数组的哪个索引上面</strong>。</li>
</ul>
<p> <strong>一个空的哈希表：</strong></p>
<img src="https://s2.loli.net/2024/05/08/CgdAGeRpVjiEoPZ.png" alt=" 一个空的哈希表" style="zoom:50%;" />

<hr>
<h4 id="哈希表节点"><a href="#哈希表节点" class="headerlink" title="哈希表节点"></a>哈希表节点</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dictEntry</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">//键</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>
    <span class="token comment">//值</span>
    <span class="token keyword">union</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">void</span> <span class="token operator">*</span>val<span class="token punctuation">;</span>
        uint64_tu64<span class="token punctuation">;</span>
        int64_ts64<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> v<span class="token punctuation">;</span>
    <span class="token comment">//指向下个哈希表节点，形成链表</span>
    <span class="token keyword">struct</span> <span class="token class-name">dictEntry</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> dictEntry<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>next属性是<strong>指向另一个哈希表节点的指针</strong>，这个指针可以将多个<strong>哈希值相同</strong>的键值对连接在一起，以此来<strong>解决键冲突（collision）的问题</strong>。</p>
<p><img src="https://s2.loli.net/2024/05/08/mdcQSf2gROHxC1z.png" alt="image-20240508162058600"></p>
<hr>
<h4 id="字典的结构"><a href="#字典的结构" class="headerlink" title="字典的结构"></a>字典的结构</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">dict</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 类型特定函数</span>
    dictType <span class="token operator">*</span>type<span class="token punctuation">;</span>
    <span class="token comment">// 私有数据</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>privdata<span class="token punctuation">;</span>
    <span class="token comment">// 哈希表</span>
    dictht ht<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// rehash索引</span>
    <span class="token comment">// 当rehash不在进行时，值为-1</span>
    in trehashidx<span class="token punctuation">;</span> <span class="token comment">/* rehashing not in progress if rehashidx == -1 */</span>
<span class="token punctuation">&#125;</span> dict<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>type属性是一个<strong>指向dictType结构</strong>的指针，每个dictType结构保存了一簇<strong>用于操作特定类型键值对的函数</strong>，Redis会为用途不同的字典设置不同的类型特定函数。</li>
<li>privdata属性则保存了需要传给那些类型特定函数的可选参数。</li>
<li>ht属性是一个<strong>包含两个项的数组</strong>，数组中的每个项都是一个<code>dictht</code>哈希表，<strong>一般情况下，字典只使用ht[0]哈希表</strong>，ht[1]哈希表只会在对ht[0]哈希表进行rehash时使用。</li>
</ul>
<p>普通状态下，没有进行rehash的字典：</p>
<img src="https://s2.loli.net/2024/05/08/QeTj7GOyLu5DUvf.png" alt="普通状态下，没有进行rehash的字典" style="zoom: 50%;" />

<p>当字典被用作数据库的底层实现，或者哈希键的底层实现时，<strong>Redis使用MurmurHash2算法来计算键的哈希值</strong>。这种算法的优点在于，<strong>即使输入的键是有规律的，算法仍能给出一个很好的随机分布性，并且算法的计算速度也非常快</strong>。</p>
<hr>
<h4 id="解决键冲突"><a href="#解决键冲突" class="headerlink" title="解决键冲突"></a>解决键冲突</h4><p>Redis的哈希表使用**链地址法（separate chaining）**来解决键冲突，<strong>每个哈希表节点都有一个next指针，多个哈希表节点可以用next指针构成一个单向链表</strong>，被分配到同一个索引上的多个节点可以用这个单向链表连接起来，这就解决了键冲突的问题。</p>
<p>因为<strong>dictEntry节点组成的链表没有指向链表表尾的指针，所以为了速度考虑，程序总是将新节点添加到链表的表头位置</strong>（复杂度为$O(1)$）。</p>
<hr>
<h4 id="rehash"><a href="#rehash" class="headerlink" title="rehash"></a>rehash</h4><p>随着操作的不断执行，哈希表保存的键值对会逐渐地增多或者减少，为了让哈希表的负载因子（load factor）维持在一个合理的范围之内，当哈希表保存的键值对数量太多或者太少时，程序需要对哈希表的大小进行相应的扩展或者收缩。这个工作通过执行rehash操作来完成。</p>
<ol>
<li>为字典的ht[1]哈希表分配空间，这个哈希表的空间大小取决于要执行的操作，以及ht[0]当前包含的键值对数量（也即是ht[0].used属性的值）</li>
<li><strong>扩展操作</strong>，那么ht[1]的大小为第一个≥<code>ht[0].used*2</code>的$2^n$；</li>
<li><strong>收缩操作</strong>，那么ht[1]的大小为第一个≥<code>ht[0].used</code>的$2^n$。</li>
<li>将保存在ht[0]中的所有键值对rehash到ht[1]上面，<strong>即重新计算键的哈希值和索引值，然后将键值对放置到ht[1]哈希表的指定位置上</strong>。</li>
<li>当ht[0]包含的所有键值对都迁移到了ht[1]之后（ht[0]变为空表），<strong>释放ht[0]，将ht[1]设置为ht[0]，并在ht[1]新创建一个空白哈希表，为下一次rehash做准备</strong>。</li>
</ol>
<p>为了避免rehash对服务器性能造成影响，<strong>rehash动作不是一次性、集中式地完成，而是分多次、渐进式地完成的</strong>。因为在进行渐进式rehash的过程中，字典会同时使用ht[0]和ht[1]两个哈希表，所以<strong>在渐进式rehash进行期间，字典的删除（delete）、查找（find）、更新（update）等操作会在两个哈希表上进行</strong>。例如，要在字典里面查找一个键的话，程序会先在ht[0]里面进行查找，如果没找到的话，就会继续到ht[1]里面进行查找，诸如此类。</p>
<p>另外，在渐进式rehash执行期间，<strong>新添加到字典的键值对一律会被保存到ht[1]里面</strong>，而ht[0]则不再进行任何添加操作，这一措施保证了ht[0]包含的键值对数量会只减不增，并随着rehash操作的执行而最终变成空表。</p>
<hr>
<h3 id="跳跃表-skiplist"><a href="#跳跃表-skiplist" class="headerlink" title="跳跃表 skiplist"></a>跳跃表 skiplist</h3><p>跳表是一种<strong>链表+多级索引</strong>的有序数据结构，它通过<strong>在每个节点中维持多个指向其他节点的指针</strong>，从而达到快速访问节点的目的。  跳表支持平均$O(logN)$、最坏$O(N)$复杂度的节点查找，还可以通过顺序操作来批量处理节点。</p>
<p>和链表、字典等数据结构被广泛地应用在Redis内部不同，<strong>Redis只在两个地方用到了跳跃表</strong>，一个是实现<strong>有序集合键</strong>，另一个是<strong>在集群节点中用作内部数据结构</strong>。</p>
<p>跳跃表示例：</p>
<img src="https://s2.loli.net/2024/05/09/dpgyu3QUiDNKWlf.png" alt="跳跃表示例" style="zoom: 50%;" />

<ul>
<li><p><strong>zskiplist结构</strong></p>
<ul>
<li>header</li>
<li>tail</li>
<li>level：记录目前跳跃表内，<strong>层数最大的节点的层数</strong>（<strong>不包括表头节点</strong>）</li>
<li>length：记录<strong>跳跃表的长度</strong>（<strong>不包括表头节点</strong>）</li>
</ul>
</li>
<li><p><strong>zskiplistNode结构</strong></p>
<ul>
<li><p><strong>level</strong>：每个层都带有两个属性：<strong>前进指针</strong>和<strong>跨度</strong>。</p>
<ul>
<li>前进指针指向<strong>位于表尾方向的其他节点</strong>。</li>
<li>跨度记录了<strong>指向节点与当前节点的距离</strong>。<strong>指向NULL的所有前进指针的跨度都为0，因为它们没有连向任何节点</strong>。</li>
</ul>
<p>  当程序从表头向表尾进行遍历时，访问会沿着层的前进指针进行。</p>
</li>
<li><p><strong>backward指针</strong>：指向<strong>前一个节点</strong>。</p>
</li>
<li><p>score：节点按各自保存的分值<strong>从小到大排列</strong>。</p>
</li>
<li><p>obj：成员对象。是<strong>指向一个字符串对象的指针</strong>。</p>
</li>
</ul>
<p>  表头节点也有backward指针、score和成员对象，不过表头节点的这些属性都不会被用到，所以图中省略了这些部分，只显示了表头节点的各个层。</p>
</li>
</ul>
<hr>
<h4 id="跳跃表节点"><a href="#跳跃表节点" class="headerlink" title="跳跃表节点"></a>跳跃表节点</h4><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">zskiplistNode</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 层</span>
    <span class="token keyword">struct</span> <span class="token class-name">zskiplistLevel</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 前进指针</span>
        <span class="token keyword">struct</span> <span class="token class-name">zskiplistNode</span> <span class="token operator">*</span>forward<span class="token punctuation">;</span>
        <span class="token comment">// 跨度</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> span<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> level<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 后退指针</span>
    <span class="token keyword">struct</span> <span class="token class-name">zskiplistNode</span> <span class="token operator">*</span>backward<span class="token punctuation">;</span>
    <span class="token comment">// 分值</span>
    <span class="token keyword">double</span> score<span class="token punctuation">;</span>
    <span class="token comment">// 成员对象</span>
    robj <span class="token operator">*</span>obj<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> zskiplistNode<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li><p>层</p>
<p> 每次创建一个新跳跃表节点的时候，程序都根据<strong>幂次定律</strong>（power law，<strong>越大的数出现的概率越小</strong>）随机生成一个<strong>介于1和32之间的值作为level数组的大小</strong>，这个大小就是层的“高度”。</p>
</li>
<li><p>跨度实际用来计算排位。</p>
<p> 在查找某个节点的过程中，<strong>将沿途访问过的所有层的跨度累计</strong>，得到的结果就是<strong>目标节点在跳表中的排位</strong>。</p>
</li>
</ol>
<p>在同一个跳跃表中，<strong>各个节点保存的成员对象必须是唯一的，但是多个节点保存的分值可以相同</strong>：分值相同的节点将<strong>按照成员对象在字典序中的大小来进行排序</strong>，成员对象较小的节点会排在前面（靠近表头的方向），而成员对象较大的节点则会排在后面（靠近表尾的方向）。</p>
<hr>
<h3 id="整数集合-intset"><a href="#整数集合-intset" class="headerlink" title="整数集合 intset"></a>整数集合 intset</h3><p>整数集合是<strong>集合键</strong>的底层实现之一。当一个集合<strong>只包含整数值元素</strong>并且<strong>元素数量不多</strong>时，Redis就会使用整数集合作为集合键的底层实现。它可以保存类型为<code>int16_t</code>、<code>int32_t</code>或者<code>int64_t</code>的整数值，并且保证<strong>集合中不会出现重复元素</strong>。</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">intset</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 编码方式</span>
    <span class="token class-name">uint32_t</span> encoding<span class="token punctuation">;</span>
    <span class="token comment">// 集合包含的元素数量</span>
    <span class="token class-name">uint32_t</span> length<span class="token punctuation">;</span>
    <span class="token comment">// 保存元素的数组</span>
    <span class="token class-name">int8_t</span> contents<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> intset<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>contents数组是整数集合的底层实现</p>
<p>  整数集合的每个元素都是contents数组的一个数组项，<strong>按值从小到大排列</strong>。</p>
<p>  虽然intset结构将contents属性声明为int8_t类型的数组，但实际上contents数组并不保存任何int8_t类型的值，<strong>contents数组的真正类型取决于encoding属性的值</strong>：</p>
<ul>
<li>encoding属性的值为<code>INTSET_ENC_INT16</code>，那么contents就是一个<code>int16_t</code>类型的数组</li>
<li>encoding属性的值为<code>INTSET_ENC_INT32</code>，那么contents就是一个<code>int32_t</code>类型的数组</li>
<li>encoding属性的值为<code>INTSET_ENC_INT64</code>，那么contents就是一个<code>int64_t</code>类型的数组</li>
</ul>
</li>
</ul>
<hr>
<h4 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h4><p>每当我们要将一个新元素添加到整数集合里面，并且<strong>新元素的类型比整数集合现有所有元素的类型都要长时</strong>，整数集合需要先进行升级（upgrade），然后才能将新元素添加到整数集合里面。</p>
<ol>
<li>根据新元素的类型，扩展整数集合底层数组的空间大小，并为新元素分配空间。</li>
<li>底层数组现有的<strong>所有元素都转换成与新元素相同的类型</strong>，并将类型转换后的元素放置到正确的位上，而且在放置元素的过程中，需要继续维持底层数组的有序性质不变 。</li>
<li>将新元素添加到底层数组里面。</li>
</ol>
<p>因为<strong>每次向整数集合添加新元素都可能会引起升级</strong>，而每次升级都需要对底层数组中已有的所有元素进行类型转换，所以向整数集合添加新元素的时间复杂度为$O(N)$。</p>
<p>整数集合的升级策略有两个好处，<strong>一个是提升整数集合的灵活性（可以添加新类型），另一个是尽可能地节约内存（只有必要时才会升级）</strong>。</p>
<p><strong>整数集合不支持降级操作</strong>，一旦对数组进行了升级，编码就会一直保持升级后的状态。</p>
<hr>
<h3 id="压缩列表-ziplist"><a href="#压缩列表-ziplist" class="headerlink" title="压缩列表 ziplist"></a>压缩列表 ziplist</h3><p>压缩列表（ziplist）是列表键和哈希键的底层实现之一。</p>
<ul>
<li>当一个<strong>列表键</strong>只包含<strong>少量列表项</strong>（&lt; 512），并且每个列表项要么就是<strong>小整数值</strong>，要么就是<strong>长度比较短的字符串</strong>(&lt; 64字节)，Redis就会使用压缩列表来做列表键的底层实现。</li>
<li>当一个<strong>哈希键</strong>只包含<strong>少量键值对</strong>，并且每个键值对的键和值要么就是<strong>小整数值</strong>，要么就是<strong>长度比较短的字符串</strong>，Redis就会使用压缩列表来做哈希键的底层实现。</li>
</ul>
<p>压缩列表是由<strong>一系列特殊编码的连续内存块组成</strong>的<strong>顺序型数据结构</strong>。一个压缩列表可以包含<strong>任意多个节点（entry）</strong>，每个节点可以<strong>保存一个字节数组或者一个整数值</strong>。 </p>
<img src="https://s2.loli.net/2024/05/11/2nDibMxHfehsySu.png" alt="压缩列表的组成部分" style="zoom: 80%;" />

<table>
<thead>
<tr>
<th>属性</th>
<th>类型</th>
<th>用途</th>
</tr>
</thead>
<tbody><tr>
<td>zlbytes</td>
<td>unit32_t</td>
<td>记录压缩列表占用的内存。<br />在对压缩列表进行内存重分配，或者计算zlend位置时使用。</td>
</tr>
<tr>
<td>zltail</td>
<td>unit32_t</td>
<td>记录压缩列表<strong>表尾节点距离起始地址有多少字节</strong>。<br />程序无需遍历整个压缩列表就可以确定表尾节点的地址。</td>
</tr>
<tr>
<td>zllen</td>
<td>unit16_t</td>
<td>记录了压缩列表包含的节点数量。<br />该属性值 &lt; UNIT16_MAX 时，就是压缩列表<strong>包含节点的数量</strong>。<br />该属性值 <strong>&#x3D; UNIT16_MAX</strong>时，节点的数量<strong>需要遍历压缩列表才能得出</strong>。</td>
</tr>
<tr>
<td>entryX</td>
<td>列表节点</td>
<td>节点的长度由节点保存的内容决定。</td>
</tr>
<tr>
<td>zlend</td>
<td>unit8_t</td>
<td>特殊值0xFF，用于<strong>标记压缩列表的末端</strong>。</td>
</tr>
</tbody></table>
<hr>
<h4 id="压缩列表节点的构成"><a href="#压缩列表节点的构成" class="headerlink" title="压缩列表节点的构成"></a>压缩列表节点的构成</h4><table>
<thead>
<tr>
<th>previous_entry_length</th>
<th>encoding</th>
<th>content</th>
</tr>
</thead>
</table>
<ul>
<li><p>previous_entry_length，记录了前一个节点的长度，以字节为单位。</p>
<p>  压缩列表可以根据这个属性，从表尾向表头遍历。</p>
</li>
<li><p>encoding，记录了节点的content属性保存的<strong>数据类型和长度</strong>。</p>
</li>
<li><p>content，保存节点的值，可以是<strong>字节数组或整数</strong>。</p>
</li>
</ul>
<hr>
<h4 id="连锁更新"><a href="#连锁更新" class="headerlink" title="连锁更新"></a>连锁更新</h4><p>Redis将在特殊情况下产生的<strong>连续多次空间扩展操作</strong>称之为<strong>连锁更新</strong>。</p>
<p>因为连锁更新在最坏情况下需要对压缩列表执行N次空间重分配操作，而每次空间重分配的最坏复杂度为$O(N)$，所以连锁更新的最坏复杂度为$O(N^2)$。</p>
<p>尽管连锁更新的复杂度较高，但它真正造成性能问题的几率很低：</p>
<ul>
<li>首先，压缩列表里要恰好有多个连续的、长度介于250字节至253字节之间的节点，连锁更新才有可能被引发，在实际中，这种情况并不多见。</li>
<li>其次，即使出现连锁更新，但只要被更新的节点数量不多，就不会对性能造成任何影响：比如说，对三五个节点进行连锁更新是绝对不会影响性能的。</li>
</ul>
<p>因为以上原因，<code>ziplistPush</code>等命令的平均复杂度仅为$O(N)$，在实际中，我们可以放心地使用这些函数，而不必担心连锁更新会影响压缩列表的性能。</p>
<hr>
<h3 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h3><p>Redis<strong>没有直接使用上述的数据结构来实现键值对数据库</strong>，而是基于这些数据结构创建了一个<strong>对象系统</strong>。这个系统包含字符串对象（String）、列表对象（List）、哈希对象（Hash）、集合对象（Set）和有序集合（Zset）对象这五种类型的对象，<strong>每种对象都至少用到了一种前面介绍的数据结构</strong>。</p>
<p>通过这五种不同类型的对象，Redis可以在执行命令之前，根据对象的类型来判断一个对象是否可以执行给定的命令。另外，可以针对不同的使用场景，<strong>为对象设置多种不同的数据结构实现</strong>，从而优化对象在不同场景下的使用效率。</p>
<p>除此之外，Redis的对象系统还实现了<strong>基于引用计数技术的内存回收机制</strong>，当程序不再使用某个对象的时候，这个对象所占用的内存就会被自动释放；另外，Redis还<strong>通过引用计数技术实现了对象共享机制</strong>，这一机制可以在适当的条件下，通过让多个数据库键共享同一个对象来节约内存。</p>
<p>最后，Redis的对象<strong>带有访问时间记录信息</strong>，该信息可以用于计算数据库键的空转时长，在服务器启用了maxmemory功能的情况下，空转时长较大的那些键可能会优先被服务器删除。</p>
<hr>
<h4 id="对象的类型与编码"><a href="#对象的类型与编码" class="headerlink" title="对象的类型与编码"></a>对象的类型与编码</h4><p>每次在Redis的数据库中新创建一个键值对时，我们至少会创建两个对象，一个对象用作键值对的键（键对象），另一个对象用作键值对的值（值对象）。</p>
<p>Redis中的每个对象都由一个redisObject结构表示，该结构中和保存数据有关的三个属性分别是type属性、encoding属性和ptr属性：</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">redisObject</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 类型</span>
    <span class="token keyword">unsigned</span> type<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token comment">// 编码</span>
    <span class="token keyword">unsigned</span> encoding<span class="token operator">:</span><span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token comment">// 指向底层实现数据结构的指针</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span> robj<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li><p>type</p>
<table>
<thead>
<tr>
<th>类型常量</th>
<th>对象的名称</th>
</tr>
</thead>
<tbody><tr>
<td>REDIS_STRING</td>
<td>字符串对象</td>
</tr>
<tr>
<td>REDIS_LIST</td>
<td>列表对象</td>
</tr>
<tr>
<td>REDIS_HASH</td>
<td>哈希对象</td>
</tr>
<tr>
<td>REDIS_SET</td>
<td>集合对象</td>
</tr>
<tr>
<td>REDIS_ZSET</td>
<td>有序集合对象</td>
</tr>
</tbody></table>
<p>  对于Redis数据库保存的键值对来说，<strong>键总是一个字符串对象</strong>，而<strong>值则可以是字符串对象、列表对象、哈希对象、集合对象或者有序集合对象的其中一种</strong>。因此，当称呼一个数据库键为“字符串键”时，实际指的是数据库键<strong>所对应的值</strong>为字符串对象。</p>
<p>  查看命令为<code>TYPE objName</code></p>
</li>
<li><p>encoding</p>
<p>  encoding记录了对象使用了什么数据结构作为对象的底层实现：</p>
<table>
<thead>
<tr>
<th>编码常量</th>
<th>编码对应的底层数据结构</th>
</tr>
</thead>
<tbody><tr>
<td>REDIS_ENCODING_INT</td>
<td>long类型的整数</td>
</tr>
<tr>
<td>REDIS_ENCODING_EMBSTR</td>
<td>embstr编码的简单动态字符串</td>
</tr>
<tr>
<td>REDIS_ENCODING_RAW</td>
<td>简单动态字符串</td>
</tr>
<tr>
<td>REDIS_ENCODING_HT</td>
<td>字典</td>
</tr>
<tr>
<td>REDIS_ENCODING_LINKEDLIST</td>
<td>双端链表</td>
</tr>
<tr>
<td>REDIS_ENCODING_ZIPLIST</td>
<td>压缩列表</td>
</tr>
<tr>
<td>REDIS_ENCODING_INTSET</td>
<td>整数集合</td>
</tr>
<tr>
<td>REDIS_ENCODING_SKIPLIST</td>
<td>跳跃表和字典</td>
</tr>
</tbody></table>
<p>  每种类型的对象都至少使用了两种不同的编码：</p>
<ul>
<li>string<ul>
<li>REDIS_ENCODING_INT</li>
<li>REDIS_ENCODING_EMBSTR</li>
<li>REDIS_ENCODING_RAW</li>
</ul>
</li>
<li>list<ul>
<li>REDIS_ENCODING_ZIPLIST</li>
<li>REDIS_ENCODING_LINKEDLIST</li>
</ul>
</li>
<li>hash<ul>
<li>REDIS_ENCODING_ZIPLIST</li>
<li>REDIS_ENCODING_HT</li>
</ul>
</li>
<li>set<ul>
<li>REDIS_ENCODING_INTSET</li>
<li>REDIS_ENCODING_HT</li>
</ul>
</li>
<li>zset<ul>
<li>REDIS_ENCODING_ZIPLIST</li>
<li>REDIS_ENCODING_SKIPLIST</li>
</ul>
</li>
</ul>
<p>  查看命令为<code>OBJECT ENCODING objName</code></p>
</li>
</ul>
<hr>
<h4 id="字符串对象"><a href="#字符串对象" class="headerlink" title="字符串对象"></a>字符串对象</h4><p>字符串对象的编码可以是int、raw或者embstr。</p>
<ul>
<li>如果字符串对象保存的是<strong>整数值</strong>，并且这个整数值<strong>可以用long类型来表示</strong>，那么字符串对象会将整数值保存在字符串对象结构的ptr属性里面（将void<em>转换成long），并将字符串对象的编码设置为*<em>int</em></em>。</li>
<li>如果字符串对象保存的是<strong>字符串值</strong>，并且这个字符串值的<strong>长度&gt;32字节</strong>，那么字符串对象将使用一个<strong>简单动态字符串（SDS）<strong>来保存这个字符串值，并将对象的编码设置为</strong>raw</strong>。</li>
<li>如果字符串对象保存的是<strong>字符串值</strong>，并且这个字符串值的<strong>长度≤32字节</strong>，那么字符串对象将使用<strong>embstr编码</strong>的方式来保存这个字符串值。</li>
</ul>
<p>embstr编码和raw编码一样，都使用<code>redisObject</code>结构和<code>sdshdr</code>结构来表示字符串对象。但<strong>raw编码会调用2次内存分配函数</strong>来分别创建<code>redisObject</code>结构和<code>sdshdr</code>结构，而<strong>embstr编码则通过调用1次内存分配函数</strong>来分配一块<strong>连续的空间</strong>，空间中依次包含<code>redisObject</code>和<code>sdshdr</code>两个结构。</p>
<img src="https://s2.loli.net/2024/05/11/ICKuGpRJNzmqWOo.png" alt="embstr编码创建的内存块结构" style="zoom:67%;" />

<p>最后要说的是，可以用<code>long double</code>类型表示的<strong>浮点数</strong>，在Redis中也是<strong>作为字符串值</strong>来保存的。如果我们要保存一个浮点数到字符串对象里面，那么程序会先将这个浮点数转换成字符串值，然后再保存转换所得的字符串值。在有需要的时候，程序会<strong>将字符串值转换回浮点数值</strong>，执行某些操作，然后<strong>再将所得的浮点数值转换回字符串值</strong>，并继续保存在字符串对象里面。</p>
<ul>
<li><p>对于int编码的字符串对象来说，如果我们向对象执行了一些命令，使得这个对象保存的不再是整数值，而是一个字符串值，那么<strong>字符串对象的编码将从int变为raw</strong>。</p>
<p>  例如通过<code>APPEND</code>命令，向保存整数值的字符串对象追加字符串值。</p>
</li>
<li><p>为Redis没有为embstr编码的字符串对象编写任何相应的修改程序，所以embstr编码的字符串对象实际上是<strong>只读</strong>的。当我们对embstr编码的字符串对象<strong>执行任何修改命令时，程序会先将对象的编码从embstr转换成raw，然后再执行修改命令</strong>。</p>
</li>
</ul>
<p>字符串对象是Redis五种类型的对象中<strong>唯一一种会被其他四种类型对象嵌套的对象</strong>。</p>
<h5 id="字符串相关命令"><a href="#字符串相关命令" class="headerlink" title="字符串相关命令"></a>字符串相关命令</h5><table>
<thead>
<tr>
<th>命令</th>
<th>举例</th>
</tr>
</thead>
<tbody><tr>
<td>SET</td>
<td>SET msg “hello world”</td>
</tr>
<tr>
<td>GET</td>
<td>GET msg</td>
</tr>
<tr>
<td>APPEND</td>
<td>APPEND msg “ again”</td>
</tr>
<tr>
<td>INCRBY</td>
<td>SET num 1<br />INCRBY num</td>
</tr>
<tr>
<td>DECRBY</td>
<td>DECRBY num</td>
</tr>
<tr>
<td>STRLEN</td>
<td>STRLEN msg</td>
</tr>
</tbody></table>
<hr>
<h4 id="列表对象"><a href="#列表对象" class="headerlink" title="列表对象"></a>列表对象</h4><p>列表对象的编码可以是ziplist或者linkedlist。列表中存放一系列的字符串，<strong>它支持随机访问，支持双端操作</strong>，就像我们使用Java中的LinkedList一样。</p>
<p>当列表对象同时满足2个条件时，使用ziplist编码：</p>
<ol>
<li>列表对象保存的所有字符串元素，<strong>长度都 &lt; 64字节</strong>。</li>
<li>列表对象保存的<strong>元素数量 ≤ 512个</strong>。</li>
</ol>
<p>两个条件的<strong>上限值是可以修改的</strong>，具体请看配置文件中关于<code>list-max-ziplist-value</code>选项和<code>list-max-ziplist-entries</code>选项的说明。</p>
<h5 id="列表相关命令"><a href="#列表相关命令" class="headerlink" title="列表相关命令"></a>列表相关命令</h5><table>
<thead>
<tr>
<th>命令</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>LPUSH &lt;key&gt; &lt;element&gt;</td>
<td>将元素推入到压缩列表的<strong>表头</strong></td>
</tr>
<tr>
<td>RPUSH &lt;key&gt; &lt;element&gt;</td>
<td>将元素推入到压缩列表的<strong>表尾</strong></td>
</tr>
<tr>
<td>LINSERT &lt;key&gt; before&#x2F;after &lt;指定元素&gt; &lt;element&gt;</td>
<td>在指定元素前面&#x2F;后面插入元素</td>
</tr>
<tr>
<td>LPOP &lt;key&gt;</td>
<td>返回<strong>表头节点</strong>，并删除</td>
</tr>
<tr>
<td>RPOP &lt;key&gt;</td>
<td>返回<strong>表尾节点</strong>，并删除</td>
</tr>
<tr>
<td>LRANGE &lt;key&gt; start stop</td>
<td>获取指定范围内的元素</td>
</tr>
<tr>
<td>LINDEX &lt;key&gt; &lt;下标&gt;</td>
<td>返回<strong>指定下标</strong>保存的元素</td>
</tr>
<tr>
<td>LLEN</td>
<td>列表的长度</td>
</tr>
<tr>
<td>RPOPPUSH 当前数组 目标数组</td>
<td>从前一个数组的最后取一个数出来放到另一个数组的头部，并返回元素</td>
</tr>
<tr>
<td>BLPOP &lt;key&gt;… timeout</td>
<td>如果列表中没有元素，那么就等待，如果指定时间（秒）内被添加了数据，那么就执行pop操作，如果超时就作废，<strong>支持同时等待多个列表，只要其中一个列表有元素了，那么就能执行</strong></td>
</tr>
</tbody></table>
<hr>
<h4 id="哈希对象"><a href="#哈希对象" class="headerlink" title="哈希对象"></a>哈希对象</h4><p>哈希对象的编码可以是ziplist或者hashtable。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Redis默认存String类似于这样：</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> hash <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Redis存Hash类型的数据类似于这样：</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span><span class="token punctuation">></span></span> hash <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ziplist编码的哈希对象，每当有新的键值对要加入时，程序会先将<strong>保存了键的压缩列表节点推入到压缩列表表尾</strong>，然后再将<strong>保存了值的压缩列表节点推入到压缩列表表尾</strong>，因此<strong>保存了键值对的两个节点总是紧挨在一起，保存键的节点在前，保存值的节点在后</strong>。</p>
<p>当哈希对象同时满足如下两个条件时，哈希对象使用ziplist编码：</p>
<ol>
<li>保存的所有键值对，<strong>键和值</strong>的字符串长度都**&lt; 64字节**。</li>
<li>保存的<strong>键值对</strong>数量**≤ 512个**。</li>
</ol>
<p>两个条件的<strong>上限值是可以修改的</strong>，具体请看配置文件中关于<code>hash-max-ziplist-value</code>选项和<code>hash-max-ziplist-entries</code>选项的说明。</p>
<h5 id="哈希相关命令"><a href="#哈希相关命令" class="headerlink" title="哈希相关命令"></a>哈希相关命令</h5><table>
<thead>
<tr>
<th>命令</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>HSET &lt;key&gt; [&lt;字段&gt; &lt;值&gt;]…</td>
<td>添加键值对</td>
</tr>
<tr>
<td>HGET &lt;key&gt; &lt;字段&gt;</td>
<td>根据键，返回值节点</td>
</tr>
<tr>
<td>HGETALL &lt;key&gt;</td>
<td>一次性返回所有的字段和值</td>
</tr>
<tr>
<td>HEXISTS &lt;key&gt; &lt;字段&gt;</td>
<td>根据指定键，查找是否存在键值对</td>
</tr>
<tr>
<td>HDEL &lt;key&gt;</td>
<td>删除Hash中的某个字段</td>
</tr>
<tr>
<td>HLEN &lt;key&gt;</td>
<td>获取键值对的数量</td>
</tr>
<tr>
<td>HVALS &lt;key&gt;</td>
<td>获取所有字段的值</td>
</tr>
</tbody></table>
<hr>
<h4 id="集合对象"><a href="#集合对象" class="headerlink" title="集合对象"></a>集合对象</h4><p>集合对象的编码可以是intset或者hashtable。</p>
<ul>
<li>intset编码的集合对象，包含的所有元素都被保存在<strong>整数集合</strong>里面。</li>
<li>hashtable编码的集合对象，字典的<strong>每个键都是一个字符串对象，每个字符串对象包含了一个集合元素，而字典的值则全部被设置为NULL</strong>。</li>
</ul>
<p>当集合对象同时满足如下两个条件时，使用inset编码：</p>
<ol>
<li>保存的元素都是整数值</li>
<li>保存的元素数量**≤512个**。</li>
</ol>
<p>第二个条件的<strong>上限值是可以修改的</strong>，具体请看配置文件中关于<code>set-max-intset-entries</code>选项的说明。</p>
<h5 id="集合相关命令"><a href="#集合相关命令" class="headerlink" title="集合相关命令"></a>集合相关命令</h5><table>
<thead>
<tr>
<th>命令</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>SADD &lt;key&gt; [&lt;value&gt;] …</td>
<td>添加元素到集合中</td>
</tr>
<tr>
<td>SCARD &lt;key&gt;</td>
<td>返回集合对象的元素数量</td>
</tr>
<tr>
<td>SISMEMBER &lt;key&gt; &lt;value&gt;</td>
<td>查找元素是否存在</td>
</tr>
<tr>
<td>SMEMBERS &lt;key&gt;</td>
<td>返回所有集合元素</td>
</tr>
<tr>
<td>SRANDMEMBER &lt;key&gt;</td>
<td>随机返回一个元素</td>
</tr>
<tr>
<td>SPOP &lt;key&gt;</td>
<td>随机返回一个元素，并删除</td>
</tr>
<tr>
<td>SREM &lt;key&gt; [&lt;value&gt;] …</td>
<td>批量删除指定的元素</td>
</tr>
<tr>
<td>SDIFF &lt;key1&gt; &lt;key2&gt;</td>
<td>集合之间的差集</td>
</tr>
<tr>
<td>SINTER &lt;key1&gt; &lt;key2&gt;</td>
<td>集合之间的交集</td>
</tr>
<tr>
<td>SUNION &lt;key1&gt; &lt;key2&gt;</td>
<td>集合之间的并集</td>
</tr>
<tr>
<td>SDIFFSTORE 目标 &lt;key1&gt; &lt;key2&gt;</td>
<td>将集合之间的差集存到目标集合中</td>
</tr>
<tr>
<td>SINTERSTORE 目标 &lt;key1&gt; &lt;key2&gt;</td>
<td>将集合之间的交集存到目标集合中</td>
</tr>
<tr>
<td>SUNIONSTORE 目标 &lt;key1&gt; &lt;key2&gt;</td>
<td>将集合之间的并集存到目标集合中</td>
</tr>
<tr>
<td>SMOVE &lt;key&gt; 目标 value</td>
<td>移动指定值到另一个集合中</td>
</tr>
</tbody></table>
<hr>
<h4 id="有序集合对象"><a href="#有序集合对象" class="headerlink" title="有序集合对象"></a>有序集合对象</h4><p>有序集合的编码可以是ziplist或者skiplist。</p>
<p>当有序集合对象同时满足以下两个条件时，使用 ziplist：</p>
<ol>
<li>ZSet 保存的元素数量 <strong>≤ 128 个</strong>；</li>
<li>每个元素的长度 <strong>≤ 64 字节</strong>。</li>
</ol>
<ul>
<li><p>ziplist编码的有序集合对象，每个集合元素使用<strong>2个紧挨在一起的压缩列表节点</strong>来保存，第一个节点保存元素的<strong>成员（member）</strong>，而第二个元素则保存元素的<strong>分值（score）</strong>。</p>
<p> 压缩列表内的集合元素<strong>按分值从小到大进行排序</strong>，分值较小的元素被放置在靠近表头的方向，而分值较大的元素则被放置在靠近表尾的方向。</p>
</li>
<li><p>skiplist编码的有序集合对象，使用一个zset结构作为底层实现。</p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">zset</span> <span class="token punctuation">&#123;</span>
    zskiplist <span class="token operator">*</span>zsl<span class="token punctuation">;</span>
    dict <span class="token operator">*</span>dict<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> zset<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>zsl跳跃表<strong>按分值从小到大</strong>保存了所有集合元素，每个跳跃表节点都保存了一个集合元素</li>
<li>dict字典为有序集合创建了一个<strong>从成员到分值的映射</strong>。通过这个字典，程序可以用$O(1)$复杂度查找给定成员的分值。</li>
</ul>
</li>
</ul>
<p>有序集合每个元素的成员都是一个<strong>字符串对象</strong>，而每个元素的分值都是一个<strong>double类型的浮点数</strong>。虽然zset结构<strong>同时使用跳跃表和字典来保存有序集合元素</strong>，但这两种数据结构都会<strong>通过指针来共享相同元素的成员和分值</strong>，所以不会产生任何重复成员或者分值，也不会因此而浪费额外的内存。</p>
<h5 id="有序集合相关命令"><a href="#有序集合相关命令" class="headerlink" title="有序集合相关命令"></a>有序集合相关命令</h5><table>
<thead>
<tr>
<th>命令</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>ZADD &lt;key&gt; [&lt;value&gt; &lt;score&gt;] …</td>
<td>将成员和分值添加到有序集合中</td>
</tr>
<tr>
<td>ZCARD &lt;key&gt;</td>
<td>获取集合元素的数量</td>
</tr>
<tr>
<td>ZCOUNT &lt;key&gt;  start stop</td>
<td>统计分值在给定范围内节点的数量</td>
</tr>
<tr>
<td>ZRANGE &lt;key&gt; start stop</td>
<td>从表头向表尾遍历有序集合，返回给定索引范围内的所有元素</td>
</tr>
<tr>
<td>ZRANGEBYSCORE &lt;key&gt; start stop [withscores] [limit]</td>
<td>通过分数段查看</td>
</tr>
<tr>
<td>ZREVRANGE</td>
<td>从表尾向表头遍历有序集合，返回给定索引范围内的所有元素</td>
</tr>
<tr>
<td>ZRANK &lt;key&gt; &lt;value&gt;</td>
<td>获取指定成员对应元素的排名</td>
</tr>
<tr>
<td>ZREM &lt;key&gt; [&lt;value&gt;] …</td>
<td>删除指定对象</td>
</tr>
<tr>
<td>ZSCORE</td>
<td>查找指定成员的分值</td>
</tr>
</tbody></table>
<hr>
<h4 id="对象共享"><a href="#对象共享" class="headerlink" title="对象共享"></a>对象共享</h4><p>对象的<strong>引用计数属性</strong>除了用于内存回收，还带有对象共享的作用。</p>
<p>以<strong>Redis 3.0</strong>来说，Redis在初始化服务器时，<strong>会创建1万个字符串对象</strong>，包含了<strong>从0到9999的所有整数值</strong>，当服务器需要用到值为0到9999的字符串对象时，服务器就会使用这些共享对象，而不是新创建对象。创建共享字符串对象的数量可以通过修改<code>redis.h/REDIS_SHARED_INTEGERS</code>常量来修改。</p>
<img src="https://s2.loli.net/2024/05/13/SQg78t69MfY5u2J.png" alt="被共享的字符串对象" style="zoom:50%;" />

<p>这些共享对象不单单只有字符串键可以使用，那些在数据结构中嵌套了字符串对象的对象（linkedlist编码的列表对象、hashtable编码的哈希对象、hashtable编码的集合对象，以及zset编码的有序集合对象）都可以使用这些共享对象。</p>
<p>由于只有在共享对象和目标对象完全相同的情况下，程序才会将共享对象用作键的值对象，而一个共享对象<strong>保存的值越复杂</strong>，验证共享对象和目标对象是否相同所需的<strong>复杂度就会越高</strong>，<strong>消耗的CPU时间也会越多</strong>，因此，Redis只对<strong>包含整数值的字符串对象</strong>进行共享。</p>
<hr>
<h4 id="对象的空转时长"><a href="#对象的空转时长" class="headerlink" title="对象的空转时长"></a>对象的空转时长</h4><p>redisObject结构还包含一个lru属性，记录了<strong>最后一次被程序访问的时间</strong>。<code>OBJECT IDLETIME</code>命令可以打印指定键的空转时长，通过<strong>当前时间 - 键的值对象的lru时间</strong>得出。<code>OBJECT IDLETIME</code>命令的实现比较特叔，在访问键的值对象时，<strong>不会修改值对象的lru属性</strong>。</p>
<p>如果服务器打开了maxmemory选项，并且用于回收内存的算法为<code>volatile-lru</code>或者<code>allkeys-lru</code>，那么当服务器占用的内存数超过maxmemory设置的上限值时，<strong>空转时长较高的键会被优先释放</strong>，从而回收内存。</p>
<hr>
<h4 id="位图对象"><a href="#位图对象" class="headerlink" title="位图对象"></a>位图对象</h4><p>Bitmap 存储的是<strong>连续的</strong>二进制数字（0 和 1），只需要一个 bit 位来表示<strong>某个元素对应的值或者状态</strong>，<strong>key 就是对应元素本身</strong> 。可以把BitMap看作一个bit数组，数组的下标就是偏移量offset。BitMap<strong>内存开销小，效率高且操作简单</strong>。</p>
<p>使用场景：统计用户活跃状态（是否登录、签到）</p>
<hr>
<h2 id="Redis为什么速度快？"><a href="#Redis为什么速度快？" class="headerlink" title="Redis为什么速度快？"></a>Redis为什么速度快？</h2><ol>
<li><p>Redis基于内存，内存的访问速度是磁盘的上千倍。</p>
</li>
<li><p>Redis基于Reactor模式，设计开发了一套高效的<strong>事件处理模型</strong>，主要是<strong>单线程事件循环</strong>和<strong>IO多路复用</strong>。</p>
<p> <img src="https://s2.loli.net/2023/11/15/2iSVrqBb7d1yMjk.png" alt="image-20231115104527768"></p>
</li>
<li><p>Redis内置了多种优化过后的数据类型&#x2F;结构实现，性能非常高。</p>
</li>
</ol>
<hr>
<h2 id="Redis持久化机制"><a href="#Redis持久化机制" class="headerlink" title="Redis持久化机制"></a>Redis持久化机制</h2><p>使用缓存的时候，我们经常需要对内存中的数据进行持久化，也就是<strong>将内存中的数据写入到硬盘中</strong>。大部分原因是为了之后<strong>重用数据</strong>（比如重启机器、机器故障之后恢复数据），或者是为了做<strong>数据同步</strong>（比如 Redis 集群的<strong>主从节点通过 RDB 文件同步数据</strong>）。</p>
<p>Redis 支持 3 种持久化方式:</p>
<ul>
<li>快照（snapshotting，RDB）</li>
<li>只追加文件（append-only file, AOF）</li>
<li>RDB 和 AOF 的混合持久化(Redis 4.0 新增）</li>
</ul>
<hr>
<h3 id="RDB-持久化"><a href="#RDB-持久化" class="headerlink" title="RDB 持久化"></a>RDB 持久化</h3><p>Redis 可以通过<strong>创建快照</strong>来获得存储在内存里面的数据在 <strong>某个时间点</strong> 上的副本。Redis 创建快照之后，可以对快照进行备份，可以将快照复制到其他服务器从而创建具有相同数据的服务器副本（Redis 主从结构，主要用来提高 Redis 性能），还可以将快照留在原地以便重启服务器的时候使用。</p>
<p>快照持久化是 Redis 默认采用的持久化方式，在 <code>redis.conf</code> 配置文件中默认有此下配置：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 在900秒(15分钟)之后，如果至少有1个key发生变化，Redis就会自动触发bgsave命令(单独一个子进程后台执行)创建快照。</span>
save <span class="token number">900</span> <span class="token number">1</span>  

<span class="token comment"># 在300秒(5分钟)之后，如果至少有10个key发生变化，Redis就会自动触发bgsave命令创建快照。</span>
save <span class="token number">300</span> <span class="token number">10</span>          

<span class="token comment"># 在60秒(1分钟)之后，如果至少有10000个key发生变化，Redis就会自动触发bgsave命令</span>
save <span class="token number">60</span> <span class="token number">10000</span>        <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><img src="https://oss.itbaima.cn/internal/markdown/2023/03/06/VK3k7EAZDT1fjIo.jpg" alt="RDB持久化机制"></p>
<hr>
<h3 id="AOF持久化"><a href="#AOF持久化" class="headerlink" title="AOF持久化"></a>AOF持久化</h3><p>与快照持久化相比，AOF （append only file）持久化的<strong>实时性更好</strong>。Redis 6.0 之后默认开启了AOF持久化，可以通过 <code>appendonly</code> 参数开启：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">appendonly <span class="token function">yes</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>开启 AOF 持久化后，每执行一条会更改 Redis 中的数据的命令，Redis 就会将该命令<strong>写入到 AOF 缓冲区 <code>server.aof_buf</code> 中，然后再写入到 AOF 文件中</strong>（此时还在系统内核缓存区未同步到磁盘），最后再根据持久化方式（ <code>fsync</code>策略）的配置来决定何时将系统内核缓存区的数据同步到硬盘中的。</p>
<p>只有同步到磁盘中才算持久化保存了，否则依然存在数据丢失的风险，比如说：系统内核缓存区的数据还未同步，磁盘机器就宕机了，那这部分数据就算丢失了。</p>
<p>AOF 文件的保存位置和 RDB 文件的位置相同，都是通过 <code>dir</code> 参数设置的，默认的文件名是 <code>appendonly.aof</code>。</p>
<p><img src="https://oss.itbaima.cn/internal/markdown/2023/03/06/JYiOHBdtT7jC98R.png" alt="AOF持久化机制"></p>
<hr>
<h2 id="Redis线程模型"><a href="#Redis线程模型" class="headerlink" title="Redis线程模型"></a>Redis线程模型</h2><p>对于<strong>读写命令</strong>来说，Redis 一直是<strong>单线程模型</strong>。在 Redis <strong>4.0</strong> 版本之后引入了多线程来执行一些<strong>大键值对的异步删除操作</strong>， Redis <strong>6.0</strong> 版本之后引入了多线程来<strong>处理网络请求（提高网络 IO 读写性能）</strong>。</p>
<hr>
<ol>
<li><p>内存是有限的，如果缓存中的所有数据都是一直保存的话，分分钟直接 Out of memory。</p>
<p><strong>Redis 中除了字符串类型有自己独有设置过期时间的命令 <code>setex</code> 外，其他方法都需要依靠 <code>expire</code> 命令来设置过期时间 。另外， <code>persist</code> 命令可以移除一个键的过期时间。</strong></p>
</li>
<li><p>很多时候，我们的业务场景就是需要某个数据只在某一时间段内存在，比如我们的短信验证码可能只在 1 分钟内有效，用户登录的 Token 可能只在 1 天内有效。</p>
<p> 如果使用传统的数据库来处理的话，一般都是自己判断过期，这样更麻烦并且性能要差很多。</p>
</li>
</ol>
<hr>
<h2 id="常见的缓存更新策略"><a href="#常见的缓存更新策略" class="headerlink" title="常见的缓存更新策略"></a>常见的缓存更新策略</h2><h3 id="Cache-Aside-Pattern-旁路缓存模式"><a href="#Cache-Aside-Pattern-旁路缓存模式" class="headerlink" title="Cache Aside Pattern 旁路缓存模式"></a>Cache Aside Pattern 旁路缓存模式</h3><p>比较适合<strong>读比较多</strong>的场景。</p>
<p>Cache Aside Pattern中，服务端需要<strong>同时维系数据库和缓存</strong>，并且<strong>以db为准</strong>。</p>
<ul>
<li><p><strong>写</strong>步骤：</p>
<ol>
<li><p>更新db</p>
</li>
<li><p><strong>直接删除</strong>cache</p>
<p> Cache Aside Pattern 旁路缓存模式下，写数据的时候，为什么选择删除cache，而不是更新cache？</p>
<ul>
<li><p>对服务端造成资源浪费</p>
<p>  删除cache更直接，如果频繁修改db，就会导致需要频繁更新cache，而cache中的数据可能都没有被访问到。</p>
</li>
<li><p>产生数据不一致问题</p>
<p>  并发场景下，更新cache产生数据不一致问题的概率会更大。</p>
</li>
</ul>
<p> 在写数据的过程中，可以<strong>先删除cache，后更新db</strong>吗？</p>
<p> 不行，可能会造成<strong>数据库和缓存数据不一致</strong>。</p>
<ol>
<li>请求1先把cache中的A数据删除；</li>
<li>请求2从db中读取数据；</li>
<li>请求1再把db中的A数据更新。</li>
</ol>
<p> 在写数据的过程中，<strong>先更新db，后删除cache</strong>就没问题了吗？</p>
<p> 还是可能出现数据不一致的问题，不过<strong>概率很小</strong>，因为缓存写入速度比数据库写入速度快很多。</p>
<ol>
<li>请求1从db中<strong>读</strong>取数据 （说明此时cache没有缓存该数据）</li>
<li>请求2<strong>更新</strong>db中的数据，删除缓存 </li>
<li>请求1将读取的数据写入cache （<strong>步骤2很难比步骤3快，因为写数据库一般会先加锁</strong>）</li>
</ol>
</li>
</ol>
</li>
<li><p><strong>读</strong>步骤：</p>
<ol>
<li>从cache中读，读取到直接返回</li>
<li>cache中读取不到，就从db读</li>
<li>把db中读取到的数据放到cache中</li>
</ol>
</li>
</ul>
<p>Cache Aside Pattern 旁路缓存模式 的<strong>缺陷</strong>：</p>
<ol>
<li><p>首次请求的数据<strong>一定不在</strong>cache中。</p>
<p> 可以将热点数据提前放入cache。</p>
</li>
<li><p>如果写操作比较频繁，会导致<strong>cache中的数据被频繁删除，影响缓存命中率</strong>。</p>
<ol>
<li><p>数据库和缓存数据强一致 </p>
<p> 加一个锁&#x2F;分布式锁，更新db的时候，同样更新cache，保证不存在线程安全问题。</p>
</li>
<li><p>短暂地允许数据库和缓存数据不一致</p>
<p> 更新db的时候，同样更新cache，<strong>给缓存加一个比较短的过期时间</strong>，即使数据不一致，影响也比较小。</p>
</li>
</ol>
</li>
</ol>
<hr>
<h3 id="Read-Write-Through-Pattern-读写穿透模式"><a href="#Read-Write-Through-Pattern-读写穿透模式" class="headerlink" title="Read&#x2F;Write Through Pattern 读写穿透模式"></a>Read&#x2F;Write Through Pattern 读写穿透模式</h3><p>读写穿透模式中，<strong>服务端把cache视为主要数据存储</strong>，从中读取数据并将数据写入其中。<strong>cache服务负责将此数据读取和写入db</strong>，从而减轻应用程序的职责。</p>
<p>这个模式在平时开发过程中<strong>非常少见</strong>，大概率是因为Redis没有提供cache将数据写入db的功能。</p>
<p>Read-Through Pattern实际只是在Cache Aside Pattern之上进行了封装。在Cache<br>Aside Pattern下，发生读请求的时候，如果cache中不存在对应的数据，是<strong>由客户端自己负责把数据写入cache</strong>，而Read Through Pattern则是<strong>cache服务自己来写入缓存的，这对客户端是透明的</strong>。</p>
<hr>
<h3 id="Write-Behind-Pattern-异步缓存写入模式"><a href="#Write-Behind-Pattern-异步缓存写入模式" class="headerlink" title="Write Behind Pattern 异步缓存写入模式"></a>Write Behind Pattern 异步缓存写入模式</h3><p>Write Behind Pattern 异步缓存写入模式 和 Read&#x2F;Write Through Pattern 读写穿透模式很相似，两者都是由cache服务负责cache和db的读写。</p>
<p>但是读写穿透模式<strong>同步更新cache和db</strong>，而<strong>异步缓存写入模式只是更新缓存，不直接更新db，改为异步批量的方式更新db</strong>。</p>
<p>这对数据一致性带来了更大的挑战，比如cache数据可能还没异步更新db，但cache服务就挂掉了。</p>
<p>这种策略在我们平时开发过程中也非常非常少见，但是不代表它的应用场景少。比如消息队列中消息的异步写入磁盘、MySQL的Innodb Buffer Pool机制都用到了这种策略。</p>
<p>Write Behind Pattern下db的<strong>写性能非常高</strong>，非常适合一些数据经常变化又对数据一致性要求没那么高的场景，比如浏览量、点赞量。</p>
<hr>
<h2 id="事务和锁机制"><a href="#事务和锁机制" class="headerlink" title="事务和锁机制"></a>事务和锁机制</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 开启事务</span>
multi

<span class="token comment"># 输入完所有要执行的命令后，可以立即执行事务</span>
<span class="token builtin class-name">exec</span>

<span class="token comment"># 可以中途取消事务</span>
discard<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>实际上<strong>整个事务是创建了一个命令队列</strong>，它不像MySQL那种在事务中也能单独得到结果，而是我们提前将所有的命令装在队列中，但是并不会执行，而是<strong>等提交事务的时候再统一执行</strong>。</p>
<p>Redis中有<strong>乐观锁</strong>，不同于MySQL的锁是悲观锁。</p>
<blockquote>
<ul>
<li>悲观锁：时刻认为别人会来抢占资源，禁止一切外来访问，直到释放锁，具有强烈的排他性质。</li>
<li>乐观锁：并不认为会有人来抢占资源，所以会直接对数据进行操作，在操作时再去验证是否有其他人抢占资源。</li>
</ul>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 监视一个目标，如果执行事务之前被监视目标发生了修改，则取消本次事务</span>
<span class="token function">watch</span>

<span class="token comment"># 取消监视</span>
unwatch<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="使用Java与Redis交互"><a href="#使用Java与Redis交互" class="headerlink" title="使用Java与Redis交互"></a>使用Java与Redis交互</h2><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- Jedis is a blazingly small and sane Redis java client. --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>5.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="基本操作-1"><a href="#基本操作-1" class="headerlink" title="基本操作"></a>基本操作</h3><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 创建Jedis对象</span>
    <span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"localhost"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 使用之后关闭连接</span>
    jedis<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>通过Jedis对象，可以直接调用命令的同名方法来执行Redis命令：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 直接使用try-with-resouse，省去close</span>
    <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">"192.168.10.3"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        jedis<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">,</span> <span class="token string">"hunter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等同于 set test hunter 命令</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>jedis<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等同于 get test 命令</span>

        jedis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span><span class="token string">"hhh"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"hunter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等同于 hset hhh name hunter</span>
        jedis<span class="token punctuation">.</span><span class="token function">hset</span><span class="token punctuation">(</span><span class="token string">"hhh"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">,</span> <span class="token string">"30"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等同于 hset hhh age 30</span>
        jedis<span class="token punctuation">.</span><span class="token function">hgetAll</span><span class="token punctuation">(</span><span class="token string">"hhh"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> v<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>k <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        jedis<span class="token punctuation">.</span><span class="token function">lpush</span><span class="token punctuation">(</span><span class="token string">"mylist"</span><span class="token punctuation">,</span> <span class="token string">"111"</span><span class="token punctuation">,</span> <span class="token string">"222"</span><span class="token punctuation">,</span> <span class="token string">"333"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等同于 lpush mylist 111 222 333 命令</span>
        jedis<span class="token punctuation">.</span><span class="token function">lrange</span><span class="token punctuation">(</span><span class="token string">"mylist"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等同于 lrange mylist 0 -1</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h3 id="SpringBoot整合Redis"><a href="#SpringBoot整合Redis" class="headerlink" title="SpringBoot整合Redis"></a>SpringBoot整合Redis</h3><p>SpringBoot整合的Redis框架底层<strong>不是用Jedis，而是Lettuce</strong>。</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>starter提供的<strong>默认配置</strong>会去连接<strong>本地的Redis服务器</strong>，并使用<strong>0号数据库</strong>。<code>application.yml</code>中可以进行相应的配置：</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">data</span><span class="token punctuation">:</span>
    <span class="token key atrule">redis</span><span class="token punctuation">:</span>
      <span class="token comment"># Redis服务器地址</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
      <span class="token comment"># 端口</span>
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
      <span class="token comment"># 使用几号数据库</span>
      <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h4 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h4><p>这个starter已经提供了两个默认的模板类：</p>
<ul>
<li><code>StringRedisTemplate</code>：当所有操作都基于字符串，或者你需要确保键和值都是字符串形式时。</li>
<li><code>RedisTemplate&lt;Object, Object&gt;</code>：当需要处理复杂的数据结构（如 Java 对象），或者需要使用 Redis 的各种复杂数据类型时。可以根据需要<strong>配置自定义的序列化器</strong>以优化性能和可读性。</li>
</ul>
<img src="https://s2.loli.net/2025/01/15/xQKzrPm1uSw2Zy6.png" alt="image-20250115140027495" style="zoom:67%;" />

<hr>
<h5 id="操作redis的模板类-RedisTemplate"><a href="#操作redis的模板类-RedisTemplate" class="headerlink" title="操作redis的模板类 RedisTemplate"></a>操作redis的模板类 RedisTemplate</h5><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> <span class="token keyword">extends</span> <span class="token class-name">RedisAccessor</span> <span class="token keyword">implements</span> <span class="token class-name">RedisOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">BeanClassLoaderAware</span> <span class="token punctuation">&#123;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment">// 序列化相关属性</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"rawtypes"</span><span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">RedisSerializer</span> keySerializer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"rawtypes"</span><span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">RedisSerializer</span> valueSerializer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"rawtypes"</span><span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">RedisSerializer</span> hashKeySerializer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"rawtypes"</span><span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">RedisSerializer</span> hashValueSerializer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> stringSerializer <span class="token operator">=</span> <span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// lua脚本执行器</span>
    <span class="token keyword">private</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">ScriptExecutor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">></span></span> scriptExecutor<span class="token punctuation">;</span>

    <span class="token comment">// 对redis各数据结构进行操作的类</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BoundOperationsProxyFactory</span> boundOperations <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BoundOperationsProxyFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ValueOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> valueOps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultValueOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ListOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> listOps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultListOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">SetOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> setOps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSetOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StreamOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">></span></span> streamOps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultStreamOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>
                                                                                      <span class="token class-name">ObjectHashMapper</span><span class="token punctuation">.</span><span class="token function">getSharedInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ZSetOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> zSetOps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultZSetOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">GeoOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> geoOps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultGeoOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">></span></span> hashOps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultHashOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HyperLogLogOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> hllOps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultHyperLogLogOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ClusterOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">,</span> <span class="token class-name">V</span><span class="token punctuation">></span></span> clusterOps <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultClusterOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong><code>StringRedisTemplate</code></strong>：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StringRedisTemplate</span> <span class="token keyword">extends</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 使用StringRedisSerializer 字符串序列化方式</span>
    <span class="token keyword">public</span> <span class="token class-name">StringRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setValueSerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setHashValueSerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="RedisSerializer-序列化接口"><a href="#RedisSerializer-序列化接口" class="headerlink" title="RedisSerializer 序列化接口"></a>RedisSerializer 序列化接口</h5><p>RedisSerializer接口，用于 Redis <strong>KEY 和 VALUE 的序列化</strong>。</p>
<p>该接口的实现类：</p>
<p><img src="https://s2.loli.net/2025/01/15/RGZVbsl1uHjhg3P.png" alt="image-20250115142642995"></p>
<ul>
<li><p>JDK 序列化方式 <strong>（默认）</strong></p>
<p>   绝大多数情况下，<strong>不推荐使用 JdkSerializationRedisSerializer 进行序列化</strong>，<strong>不方便人工排查数据</strong>。</p>
</li>
<li><p>String 序列化方式</p>
</li>
<li><p>JSON 序列化方式</p>
</li>
<li><p>XML 序列化方式</p>
</li>
</ul>
<p>展示一下采用<strong>默认的JDK序列化</strong>的存储效果：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisTest</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ValueOperations</span> valueOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        valueOperations<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"hunter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>valueOperations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>所有的值的操作都被封装到了<code>ValueOperations</code>对象中，而普通的键操作直接通过模板对象就可以使用了，大致使用方式其实和Jedis一致。</strong></p>
<p>虽然在程序中能正常读取指定的key，但是<strong>直接查看redis中存储的数据</strong>，会发现KEY前面带着奇怪的16进制字符 ， VALUE也是一串16进制字符，<strong>可读性极差</strong>。</p>
<img src="https://s2.loli.net/2025/01/15/kKtSEcwyCz4HTIZ.png" alt="image-20250115154243763" style="zoom:80%;" />

<p><strong>实际线上场景，绝大多数情况下，KEY会使用StringRedisSerializer，VALUE使用JSON序列化居多</strong>：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置连接工厂</span>
        
        <span class="token comment">// 使用StringRedisSerializer.UTF_8作为key和hash key的序列化器</span>
        template<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 使用GenericJackson2JsonRedisSerializer作为value和hash value的序列化器</span>
        template<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">setHashValueSerializer</span><span class="token punctuation">(</span><span class="token class-name">RedisSerializer</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 对配置进行初始化</span>
        template<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> template<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisTest</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">></span></span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">ValueOperations</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">></span></span> valueOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setPhoneNumber</span><span class="token punctuation">(</span><span class="token string">"1234567890"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        user<span class="token punctuation">.</span><span class="token function">setUserName</span><span class="token punctuation">(</span><span class="token string">"hunter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        valueOperations<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>valueOperations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>查看Redis中存储的数据，拥有良好的可读性：</p>
<img src="https://s2.loli.net/2025/01/15/XVykFqoNpBP24zt.png" alt="image-20250115162141039" style="zoom: 80%;" />

<hr>
<h5 id="自定义Redis序列化的实现"><a href="#自定义Redis序列化的实现" class="headerlink" title="自定义Redis序列化的实现"></a>自定义Redis序列化的实现</h5><hr>
<h4 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h4><p>由于Spring没有专门的Redis事务管理器，所以只能借用JDBC提供的：</p>
<pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mysql-connector-j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">StringRedisTemplate</span> template<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        template<span class="token punctuation">.</span><span class="token function">setEnableTransactionSupport</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//需要开启事务</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Transactional</span>  <span class="token comment">// 需要添加事务注解</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        template<span class="token punctuation">.</span><span class="token function">multi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"d"</span><span class="token punctuation">,</span> <span class="token string">"xxxxx"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>还可以为RedisTemplate对象配置一个Serializer来实现对象的JSON存储：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">contextLoad2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 注意Student需要实现序列化接口才能存入Redis</span>
    template<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"student"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Student</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"student"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="使用Redis做缓存"><a href="#使用Redis做缓存" class="headerlink" title="使用Redis做缓存"></a>使用Redis做缓存</h2><h3 id="MyBatis的二级存储"><a href="#MyBatis的二级存储" class="headerlink" title="MyBatis的二级存储"></a>MyBatis的二级存储</h3><p><img src="https://oss.itbaima.cn/internal/markdown/2023/03/06/JKDHFTiCr2t5Oj9.png" alt="MyBatis二级缓存示意"></p>
<p>MyBatis的二级缓存，是<strong>Mapper级别的缓存，能作用于所有会话</strong>。但是MyBati<strong>s默认的二级缓存只能是单机的</strong>。将Redis作为MyBatis的二级缓存，就能实现多台服务器使用同一个二级缓存，所有的服务器全部存储在Redis服务器上。</p>
<hr>
<h4 id="编写缓存类"><a href="#编写缓存类" class="headerlink" title="编写缓存类"></a>编写缓存类</h4><p>需要编写缓存类<code>RedisMyBatisCache</code>，<strong>实现MyBatis提供的<code>Cache</code>接口</strong>：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">Cache</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisMyBatisCache</span> <span class="token keyword">implements</span> <span class="token class-name">Cache</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> template<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>

    <span class="token comment">// 构造方法必须带一个String类型的参数接收id</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisMyBatisCache</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 初始化时通过配置类将RedisTemplate给过来</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> template<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">RedisMyBatisCache</span><span class="token punctuation">.</span>template <span class="token operator">=</span> template<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">putObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token class-name">Object</span> o1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 直接向Redis数据库中丢数据即可，o就是Key，o1就是Value，60秒为过期时间</span>
        template<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> o1<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 根据Key直接从Redis数据库中获取值</span>
        <span class="token keyword">return</span> template<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">removeObject</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 根据Key删除</span>
        <span class="token keyword">return</span> template<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 由于template中没封装清除操作，只能通过connection来执行</span>
        template<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RedisCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> connection <span class="token operator">-></span>
                connection<span class="token punctuation">.</span><span class="token function">serverCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dbSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">RedisCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> connection <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// 通过connection对象执行清空操作</span>
            connection<span class="token punctuation">.</span><span class="token function">serverCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flushDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 这里也是使用connection对象来获取当前的Key数量</span>
        <span class="token keyword">return</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">requireNonNull</span><span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">RedisServerCommands</span><span class="token operator">::</span><span class="token function">dbSize</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="编写配置类"><a href="#编写配置类" class="headerlink" title="编写配置类"></a>编写配置类</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyBatisConfiguration</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> template<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">// 把RedisTemplate给到RedisMybatisCache</span>
        <span class="token class-name">RedisMyBatisCache</span><span class="token punctuation">.</span><span class="token function">setTemplate</span><span class="token punctuation">(</span>template<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h4 id="在Mapper上启用此缓存"><a href="#在Mapper上启用此缓存" class="headerlink" title="在Mapper上启用此缓存"></a>在Mapper上启用此缓存</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 修改缓存实现类implementation为自定义的缓存类RedisMyBatisCache</span>
<span class="token annotation punctuation">@CacheNamespace</span><span class="token punctuation">(</span>implementation <span class="token operator">=</span> <span class="token class-name">RedisMyBatisCache</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Mapper</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MainMapper</span> <span class="token punctuation">&#123;</span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select name from student where sid = 1"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">getSid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h3 id="Token持久化存储"><a href="#Token持久化存储" class="headerlink" title="Token持久化存储"></a>Token持久化存储</h3><h4 id="实现PersistentTokenRepository接口"><a href="#实现PersistentTokenRepository接口" class="headerlink" title="实现PersistentTokenRepository接口"></a>实现<code>PersistentTokenRepository</code>接口</h4><p>单独使用SpringSecurity时，remember-me的Token<strong>可以设置为持久化存储，是存储在数据库中</strong>，那么现在让Token信息存储在缓存中：</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// 实现PersistentTokenRepository接口</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisTokenRepository</span> <span class="token keyword">implements</span> <span class="token class-name">PersistentTokenRepository</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Key名称前缀，用于区分</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">REMEMBER_ME_KEY</span> <span class="token operator">=</span> <span class="token string">"spring:security:rememberMe:"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> template<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createNewToken</span><span class="token punctuation">(</span><span class="token class-name">PersistentRememberMeToken</span> token<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 这里要放两个，一个存seriesId->Token，一个存username->seriesId，因为删除时是通过username删除</span>
        template<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">REMEMBER_ME_KEY</span> <span class="token operator">+</span> <span class="token string">"username:"</span> <span class="token operator">+</span> token<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">.</span><span class="token function">getSeries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token constant">REMEMBER_ME_KEY</span> <span class="token operator">+</span> <span class="token string">"username:"</span> <span class="token operator">+</span> token<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">DAYS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setToken</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 先获取，然后修改创建一个新的，再放入</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> series<span class="token punctuation">,</span> <span class="token class-name">String</span> tokenValue<span class="token punctuation">,</span> <span class="token class-name">Date</span> lastUsed<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">PersistentRememberMeToken</span> token <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span>series<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>token <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setToken</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PersistentRememberMeToken</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> series<span class="token punctuation">,</span> tokenValue<span class="token punctuation">,</span> lastUsed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">PersistentRememberMeToken</span> <span class="token function">getTokenForSeries</span><span class="token punctuation">(</span><span class="token class-name">String</span> seriesId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span>seriesId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 通过username找seriesId直接删除这两个</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">removeUserTokens</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> series <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> template<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">REMEMBER_ME_KEY</span> <span class="token operator">+</span> <span class="token string">"username:"</span> <span class="token operator">+</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token constant">REMEMBER_ME_KEY</span> <span class="token operator">+</span> series<span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token constant">REMEMBER_ME_KEY</span> <span class="token operator">+</span> <span class="token string">"username:"</span> <span class="token operator">+</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>


    <span class="token comment">// 由于PersistentRememberMeToken没实现序列化接口，这里只能用Hash来存储了，所以单独编写一个set和get操作</span>
    <span class="token keyword">private</span> <span class="token class-name">PersistentRememberMeToken</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token class-name">String</span> series<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> template<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token constant">REMEMBER_ME_KEY</span> <span class="token operator">+</span> series<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PersistentRememberMeToken</span><span class="token punctuation">(</span>
            <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"series"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"tokenValue"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"date"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setToken</span><span class="token punctuation">(</span><span class="token class-name">PersistentRememberMeToken</span> token<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> token<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"series"</span><span class="token punctuation">,</span> token<span class="token punctuation">.</span><span class="token function">getSeries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"tokenValue"</span><span class="token punctuation">,</span> token<span class="token punctuation">.</span><span class="token function">getTokenValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"date"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token operator">+</span>token<span class="token punctuation">.</span><span class="token function">getDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">opsForHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token constant">REMEMBER_ME_KEY</span> <span class="token operator">+</span> token<span class="token punctuation">.</span><span class="token function">getSeries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span><span class="token constant">REMEMBER_ME_KEY</span> <span class="token operator">+</span> token<span class="token punctuation">.</span><span class="token function">getSeries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">DAYS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h4 id="在Mapper上启用MyBatis的Redis二级缓存"><a href="#在Mapper上启用MyBatis的Redis二级缓存" class="headerlink" title="在Mapper上启用MyBatis的Redis二级缓存"></a>在Mapper上启用MyBatis的Redis二级缓存</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Account</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token class-name">String</span> username<span class="token punctuation">;</span>
    <span class="token class-name">String</span> password<span class="token punctuation">;</span>
    <span class="token class-name">String</span> role<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@CacheNamespace</span><span class="token punctuation">(</span>implementation <span class="token operator">=</span> <span class="token class-name">RedisMyBatisCache</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Mapper</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">AccountMapper</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select * from users where username = #&#123;username&#125;"</span><span class="token punctuation">)</span>
    <span class="token class-name">Account</span> <span class="token function">getAccountByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h4 id="实现验证Service"><a href="#实现验证Service" class="headerlink" title="实现验证Service"></a>实现验证Service</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthService</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token class-name">AccountMapper</span> mapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UsernameNotFoundException</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Account</span> account <span class="token operator">=</span> mapper<span class="token punctuation">.</span><span class="token function">getAccountByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>account <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token class-name">User</span>
            <span class="token punctuation">.</span><span class="token function">withUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span>account<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span>account<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h4 id="SecurityConfiguration配置"><a href="#SecurityConfiguration配置" class="headerlink" title="SecurityConfiguration配置"></a>SecurityConfiguration配置</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SecurityConfiguration</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTokenRepository</span> tokenRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">AuthService</span> authService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SecurityFilterChain</span> <span class="token function">securityFilterChain</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurity</span> httpSecurity<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> httpSecurity
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">.</span><span class="token function">rememberMe</span><span class="token punctuation">(</span>rememberMeConfigurer <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
                rememberMeConfigurer
                    <span class="token punctuation">.</span><span class="token function">tokenRepository</span><span class="token punctuation">(</span>tokenRepository<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 持久化存储</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>authService<span class="token punctuation">)</span> <span class="token comment">// 自定义用户验证逻辑</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 将BCryptPasswordEncoder直接注册为Bean，Security会自动处理密码对比</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="三大缓存问题"><a href="#三大缓存问题" class="headerlink" title="三大缓存问题"></a>三大缓存问题</h2><h3 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h3><h3 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h3><h3 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h3>
    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Redis/" rel="tag"><i class="fa fa-tag"></i> Redis</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/10/28/Spring-Boot/" rel="prev" title="Spring Boot">
                  <i class="fa fa-angle-left"></i> Spring Boot
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2024/01/23/%E5%9B%BE%E5%BA%8A/" rel="next" title="Spring Boot">
                  Spring Boot <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments utterances-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Hunter</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>


<script class="next-config" data-name="utterances" type="application/json">{"enable":true,"repo":"Hunter1023/Hunter1023.github.io","issue_term":"pathname","theme":"github-light"}</script>
<script src="/js/third-party/comments/utterances.js"></script>

</body>
</html>
